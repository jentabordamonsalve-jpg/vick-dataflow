<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>VICK DATAFLOW - Plataforma Integral (Final)</title>

<!-- Librer√≠as -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --vick-blue:#004c97; --vick-light:#1a73e8; --vick-green:#009e60; --bg:#f3f8fc; --card:#ffffff; --text:#12202b;
}
/* Dark mode vars (will be toggled) */
:root.dark{ --vick-blue:#05223a; --vick-light:#0b2b4a; --vick-green:#13b76a; --bg:#0f1720; --card:#0b1220; --text:#e6eef6 }
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
.sidebar{width:270px;background:var(--vick-blue);color:white;height:100vh;position:fixed;padding-top:18px;box-shadow:0 6px 18px rgba(0,0,0,0.12)}
.sidebar h2{text-align:center;margin:0 0 12px;font-size:20px}
.sidebar a{display:block;padding:12px 18px;color:white;text-decoration:none;font-weight:700;border-bottom:1px solid rgba(255,255,255,0.06)}
.sidebar a:hover{background:var(--vick-light)}
.content{margin-left:290px;padding:20px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.header .actions{display:flex;gap:8px}
.btn{background:var(--vick-light);color:white;padding:10px 12px;border-radius:8px;border:none;font-weight:700;cursor:pointer}
.btn.secondary{background:transparent;border:2px solid var(--vick-blue);color:var(--vick-blue)}
.card{background:var(--card);border-radius:12px;padding:18px;margin-bottom:18px;box-shadow:0 10px 30px rgba(12,35,70,0.06)}
.chart-container{height:320px}
.row{display:grid;grid-template-columns:1fr 380px;gap:18px}
/* Map */
#map{height:360px;border-radius:10px}
/* Chatbot and avatar */
#avatar-btn{position:fixed;right:24px;bottom:24px;width:76px;height:76px;border-radius:50%;background:var(--vick-green);display:flex;align-items:center;justify-content:center;box-shadow:0 12px 30px rgba(0,0,0,0.18);cursor:pointer;z-index:1400}
#chat-panel{position:fixed;right:24px;bottom:120px;width:360px;height:500px;background:var(--card);border-radius:12px;box-shadow:0 20px 60px rgba(2,22,50,0.2);display:none;flex-direction:column;z-index:1400}
.chat-header{background:var(--vick-blue);color:white;padding:12px;border-radius:12px 12px 0 0;font-weight:700}
.chat-body{flex:1;overflow:auto;padding:12px}
.chat-input{display:flex;padding:12px;border-top:1px solid rgba(0,0,0,0.06)}
.chat-input input{flex:1;padding:10px;border-radius:8px;border:1px solid #ddd}
.chat-input button{margin-left:8px;padding:10px 12px;border-radius:8px;border:none;background:var(--vick-green);color:white;font-weight:700}
.message{margin-bottom:10px;padding:8px;border-radius:8px}
.message.bot{background:#eefaf1}
.message.user{background:#e8f1ff;text-align:right}
/* Tooltips and notifications */
.tooltip{position:relative;display:inline-block}
.tooltip .tooltip-text{visibility:hidden;width:190px;background:var(--vick-blue);color:white;text-align:center;padding:6px;border-radius:6px;position:absolute;z-index:10;bottom:125%;left:50%;transform:translateX(-50%);opacity:0;transition:opacity .2s}
.tooltip:hover .tooltip-text{visibility:visible;opacity:1}
.notification{position:fixed;top:20px;right:20px;background:var(--vick-light);color:white;padding:12px 16px;border-radius:8px;display:none;z-index:1500}
@media(max-width:1000px){.sidebar{display:none}.content{margin:12px}}
</style>
</head>
<body>

<div class="sidebar">
  <h2>VICK DATAFLOW</h2>
  <a href="#dashboard">Dashboard</a>
  <a href="#inventarios">Inventarios</a>
  <a href="#tendencias">Tendencias</a>
  <a href="#recomendaciones">Recomendaciones</a>
  <a href="#mapa">Mapa Interactivo</a>
  <a href="#historico">Hist√≥rico Mensual</a>
</div>

<div class="content">
  <div class="header">
    <div>
      <h1 style="margin:0;font-size:22px">VICK DATAFLOW - Procter &amp; Gamble</h1>
      <div style="font-size:13px;color:gray;margin-top:6px">An√°lisis de demanda e inventarios | Vick Vaporub</div>
    </div>
    <div class="actions">
      <button class="btn" id="exportPdfBtn">‚¨á Exportar PDF</button>
      <button class="btn secondary" id="darkModeBtn">üåô Modo Oscuro</button>
    </div>
  </div>

  <!-- Dashboard + side panel -->
  <div class="card row" id="dashboard">
    <div>
      <h3>Demanda y Proyecci√≥n IA</h3>
      <div class="chart-container"><canvas id="demandaChart"></canvas></div>
      <div style="margin-top:12px" id="prediccionWrapper" class="card">
        <h4 style="margin:0 0 8px">Proyecci√≥n IA (6 d√≠as)</h4>
        <div class="chart-container"><canvas id="prediccionChart"></canvas></div>
      </div>
    </div>
    <div>
      <div class="card" style="margin-bottom:12px">
        <h4 style="margin:0 0 8px">Alertas</h4>
        <div id="alertas"></div>
      </div>
      <div class="card">
        <h4 style="margin:0 0 8px">Recomendaciones R√°pidas</h4>
        <div id="reco"></div>
      </div>
    </div>
  </div>

  <!-- Inventarios + Tendencias -->
  <div class="row">
    <div class="card">
      <h3>Inventarios por ciudad</h3>
      <div class="chart-container"><canvas id="inventarioChart"></canvas></div>
    </div>
    <div class="card">
      <h3>Tendencias</h3>
      <div class="city-buttons tooltip" style="margin-bottom:10px">
        <button class="btn" onclick="cambiarCiudad('Bogot√°')">Bogot√°</button>
        <button class="btn" onclick="cambiarCiudad('Medell√≠n')">Medell√≠n</button>
        <button class="btn" onclick="cambiarCiudad('Cali')">Cali</button>
        <span class="tooltip-text">Selecciona una ciudad para actualizar tendencias y recomendaciones</span>
      </div>
      <div style="margin-top:12px" class="chart-container"><canvas id="tendenciasChart"></canvas></div>
    </div>
  </div>

  <!-- Mapa interactivo -->
  <div id="mapa" class="card">
    <h3>Mapa interactivo de inventarios</h3>
    <div id="map"></div>
  </div>

  <!-- Hist√≥rico mensual -->
  <div id="historico" class="card">
    <h3>Hist√≥rico mensual</h3>
    <div style="display:flex;gap:12px;align-items:center;margin-bottom:10px">
      <label for="monthSelect">Seleccione mes:</label>
      <select id="monthSelect" style="padding:8px;border-radius:6px;border:1px solid #ddd">
        <option value="0">Enero</option>
        <option value="1">Febrero</option>
        <option value="2">Marzo</option>
        <option value="3" selected>Abril</option>
        <option value="4">Mayo</option>
        <option value="5">Junio</option>
        <option value="6">Julio</option>
        <option value="7">Agosto</option>
        <option value="8">Septiembre</option>
        <option value="9">Octubre</option>
        <option value="10">Noviembre</option>
        <option value="11">Diciembre</option>
      </select>
    </div>
    <div class="chart-container"><canvas id="historicoChart"></canvas></div>
  </div>

</div>

<!-- Avatar / Chatbot -->
<div id="avatar-btn" title="Asistente VICK"><img src="data:image/svg+xml;utf8,<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'><circle cx='60' cy='60' r='60' fill='%23009e60'/><g transform='translate(16,16)'><circle cx='44' cy='30' r='22' fill='%23fff'/><path d='M44 64c-18 0-32 8-32 18v4h64v-4c0-10-14-18-32-18z' fill='%23f1f5fb'/><circle cx='36' cy='28' r='3.8' fill='%23022b49'/><circle cx='52' cy='28' r='3.8' fill='%23022b49'/></g></svg>" alt="avatar"/></div>
<div id="chat-panel">
  <div class="chat-header">Asistente VICK - Soporte</div>
  <div id="chat-body" class="chat-body">
    <div class="message bot">Hola üëã Soy el asistente VICK. Puedo ayudar con inventarios, tendencias y recomendaciones.</div>
  </div>
  <div class="chat-input">
    <input id="chatInput" placeholder="Escribe tu pregunta..." onkeydown="if(event.key==='Enter') sendChat()" />
    <button onclick="sendChat()">Enviar</button>
  </div>
</div>

<div id="notification" class="notification"></div>

<script>
// ---------- Datos simulados ----------
const ciudades = {
  "Bogot√°": { gripe: 48, tos: 32, frio: 60, inventario: 22, ventasSemana: 4200 },
  "Medell√≠n": { gripe: 27, tos: 33, frio: 45, inventario: 41, ventasSemana: 2850 },
  "Cali": { gripe: -12, tos: 5, frio: 15, inventario: 78, ventasSemana: 3100 }
};

// ---------- Graficas iniciales ----------
const demandaCtx = document.getElementById('demandaChart').getContext('2d');
const demandaChart = new Chart(demandaCtx, {
  type:'line',
  data:{ labels:['Lun','Mar','Mie','Jue','Vie','Sab'], datasets:[{ label:'Demanda (unidades)', data:[2000,2500,4000,6000,5500,7000], borderColor: getColor('--vick-light'), backgroundColor: 'rgba(26,115,232,0.08)', fill:true, tension:0.3 }]},
  options:{ responsive:true, maintainAspectRatio:false }
});

const inventarioCtx = document.getElementById('inventarioChart').getContext('2d');
const inventarioChart = new Chart(inventarioCtx, {
  type:'bar',
  data:{ labels:['Bogot√°','Medell√≠n','Cali'], datasets:[{ label:'Inventario %', data:[22,41,78], backgroundColor:['#ff6b6b','#ffb84d','#6fdc6f']}]},
  options:{ responsive:true, maintainAspectRatio:false }
});

const tendenciasCtx = document.getElementById('tendenciasChart').getContext('2d');
const tendenciasChart = new Chart(tendenciasCtx, {
  type:'bar',
  data:{ labels:['Gripe','Tos','Clima fr√≠o'], datasets:[{ label:'Tendencia (7d)', data:[48,32,60], backgroundColor:getColor('--vick-light') }]},
  options:{ responsive:true, maintainAspectRatio:false }
});

const predCtx = document.getElementById('prediccionChart').getContext('2d');
let predChart = new Chart(predCtx, { type:'line', data:{ labels:['Hoy','+1d','+2d','+3d','+4d','+5d'], datasets:[{ label:'Proyecci√≥n IA', data:[22,26,30,28,35,33], borderColor:getColor('--vick-green'), tension:0.3 }]}, options:{ responsive:true, maintainAspectRatio:false } });

// Historico mensual chart
const historicoCtx = document.getElementById('historicoChart').getContext('2d');
let historicoChart = new Chart(historicoCtx, { type:'line', data:{ labels:['Semana 1','Semana 2','Semana 3','Semana 4'], datasets:[{ label:'Ventas (unidades)', data:[1200,1400,1300,1500], borderColor:getColor('--vick-light'), tension:0.3 }]}, options:{ responsive:true, maintainAspectRatio:false } });

// ---------- Helpers ----------
function getColor(varName){
  return getComputedStyle(document.documentElement).getPropertyValue(varName) || '#1a73e8';
}

function mostrarNotificacion(texto){
  const n = document.getElementById('notification');
  n.innerText = texto; n.style.display = 'block'; n.style.opacity = '1';
  setTimeout(()=>{ n.style.opacity='0'; n.style.display='none'; }, 3000);
}

// Inicializar alertas y recomendaciones
function actualizarAlertas(){
  const cont = document.getElementById('alertas'); cont.innerHTML='';
  for(const c of Object.keys(ciudades)){
    const d = ciudades[c];
    const div = document.createElement('div'); div.className='message bot tooltip';
    div.innerText = `${c}: Gripe ${d.gripe}% ‚Äî Inventario ${d.inventario}%`;
    const tip = document.createElement('span'); tip.className='tooltip-text'; tip.innerText = 'Alerta generada autom√°ticamente seg√∫n tendencias y stock.';
    div.appendChild(tip);
    cont.appendChild(div);
  }
}
actualizarAlertas();

function actualizarRecomendaciones(){
  const cont = document.getElementById('reco'); cont.innerHTML='';
  for(const c of Object.keys(ciudades)){
    const d = ciudades[c];
    const div = document.createElement('div'); div.className='message bot';
    const texto = d.inventario<30 ? `Enviar unidades urgentes a ${c}` : d.inventario<50 ? `Refuerzo moderado en ${c}` : `${c} con abastecimiento OK`;
    div.innerText = texto; cont.appendChild(div);
  }
}
actualizarRecomendaciones();

// Cambiar ciudad (tendencias + recomendaci√≥n + notificaci√≥n)
function cambiarCiudad(ciudad){
  const d = ciudades[ciudad];
  tendenciasChart.data.datasets[0].data = [d.gripe, d.tos, d.frio]; tendenciasChart.update();
  actualizarRecomendaciones(); mostrarNotificacion(`Datos actualizados para ${ciudad}`);
}

// ---------- Leaflet Map ----------
const map = L.map('map', { zoomControl:true, scrollWheelZoom:false }).setView([4.6, -74.08], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors' }).addTo(map);

const markers = {};
const cityCoords = { 'Bogot√°':[4.7110,-74.0721], 'Medell√≠n':[6.2442,-75.5812], 'Cali':[3.4516,-76.5320] };
for(const c of Object.keys(ciudades)){
  const inv = ciudades[c].inventario;
  const color = inv<30 ? 'red' : inv<50 ? 'orange' : 'green';
  const marker = L.circleMarker(cityCoords[c], { radius:12, color:color, fillColor:color, fillOpacity:0.6 }).addTo(map);
  marker.bindPopup(`<b>${c}</b><br>Inventario: ${inv}%`);
  markers[c]=marker;
}

// ---------- Hist√≥rico mensual (simulaci√≥n) ----------
const monthsData = {
  0: [1200,1300,1100,1400],1:[1100,1150,1300,1250],2:[1250,1400,1350,1500],3:[1400,1500,1450,1600],4:[1300,1350,1420,1500],5:[1200,1300,1280,1350],6:[1500,1600,1550,1700],7:[1400,1420,1380,1450],8:[1300,1280,1250,1320],9:[1600,1700,1650,1800],10:[1500,1550,1520,1600],11:[1700,1800,1750,1900]
};

document.getElementById('monthSelect').addEventListener('change', (e)=>{
  const v = e.target.value; historicoChart.data.datasets[0].data = monthsData[v]; historicoChart.update(); mostrarNotificacion('Hist√≥rico actualizado');
});

// ---------- Exportar a PDF ----------
document.getElementById('exportPdfBtn').addEventListener('click', async ()=>{
  mostrarNotificacion('Generando PDF...');
  // tomar screenshot de la secci√≥n content
  const content = document.querySelector('.content');
  const canvas = await html2canvas(content, { scale:1.6 });
  const imgData = canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('l','pt','a4');
  const pdfWidth = pdf.internal.pageSize.getWidth();
  const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
  pdf.addImage(imgData,'PNG',0,0,pdfWidth,pdfHeight);
  pdf.save('reporte_vick_dataflow.pdf');
});

// ---------- Modo oscuro ----------
const darkBtn = document.getElementById('darkModeBtn');
let dark=false;
darkBtn.addEventListener('click', ()=>{
  dark = !dark; if(dark) document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark');
  // actualizar colores de charts
  setTimeout(()=>{ refreshChartColors(); }, 250);
});

function refreshChartColors(){
  demandaChart.data.datasets[0].borderColor = getColor('--vick-light'); demandaChart.data.datasets[0].backgroundColor = getColor('--vick-light'); demandaChart.update();
  tendenciasChart.data.datasets[0].backgroundColor = getColor('--vick-light'); tendenciasChart.update();
  predChart.data.datasets[0].borderColor = getColor('--vick-green'); predChart.update();
  historicoChart.data.datasets[0].borderColor = getColor('--vick-light'); historicoChart.update();
}

// ---------- Chatbot (simple) ----------
const avatarBtn = document.getElementById('avatar-btn'); const chatPanel = document.getElementById('chat-panel');
avatarBtn.addEventListener('click', ()=>{ chatPanel.style.display = chatPanel.style.display==='flex' ? 'none' : 'flex'; mostrarNotificacion('Asistente VICK activado'); });

const chatBody = document.getElementById('chat-body'); function appendChat(msg, who='bot'){ const d = document.createElement('div'); d.className='message '+(who==='bot'?'bot':'user'); d.innerText=msg; chatBody.appendChild(d); chatBody.scrollTop = chatBody.scrollHeight; }

function sendChat(){ const txt = document.getElementById('chatInput').value.trim(); if(!txt) return; appendChat(txt,'user'); document.getElementById('chatInput').value=''; handleChat(txt); }

function handleChat(text){ const m = text.toLowerCase(); setTimeout(()=>{ if(m.includes('inventario')||m.includes('stock')){ appendChat(Object.keys(ciudades).map(c=>`${c}: ${ciudades[c].inventario}%`).join('\n')); }
else if(m.includes('recomend')){ appendChat('Recomendaci√≥n: Priorizar env√≠o a Bogot√° (+15%). Considere refuerzo a Medell√≠n.'); }
else if(m.includes('tendenc')||m.includes('gripe')||m.includes('tos')){ appendChat('Tendencias: Bogot√° tiene aumento de gripe. Use campa√±as digitales localizadas.'); }
else if(m.includes('mapa')){ appendChat('Mapa: muestra marcadores con estado de inventario por ciudad.'); }
else{ appendChat('Lo siento, no entend√≠. Puedes preguntar: \"Inventario Bogot√°\", \"Recomendaci√≥n\" o \"Tendencias Medell√≠n\".'); } }, 700);
}

// ---------- Monitoreo automatizado ----------
setInterval(()=>{ if(ciudades['Bogot√°'].inventario<30) mostrarNotificacion('‚ö†Ô∏è Inventario cr√≠tico en Bogot√° - revisar env√≠o'); }, 10000);

// Inicial
mostrarNotificacion('VICK DATAFLOW cargado');

</script>
</body>
</html>
